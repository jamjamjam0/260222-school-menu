<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ í•™êµ ê¸‰ì‹ ìš”ì • ğŸ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #4a4a4a;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .cute-input {
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 12px 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        .cute-input:focus {
            border-color: #a6c1ee;
            box-shadow: 0 0 0 3px rgba(166, 193, 238, 0.3);
        }
        .cute-btn {
            background: linear-gradient(120deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            color: #fff;
            border: none;
            border-radius: 16px;
            padding: 12px 24px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .cute-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 154, 158, 0.4);
        }
        .cute-btn:active {
            transform: translateY(0);
        }
        .school-list-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .school-list-item:hover {
            background: #fdf2f8;
            border-radius: 8px;
        }
        .meal-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        .meal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, #ff9a9e, #a6c1ee);
        }
        .dish-text {
            line-height: 1.8;
            font-size: 1.1rem;
        }
        .allergy-info {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>

    <div class="glass-panel w-full max-w-md p-6 mt-8">
        <h1 class="text-3xl text-center mb-6" style="color: #6b7280;">ğŸ± ìš°ë¦¬ í•™êµ ê¸‰ì‹ ìš”ì • ğŸ§šâ€â™€ï¸</h1>

        <!-- í•™êµ ê²€ìƒ‰ ì„¹ì…˜ -->
        <div class="mb-6">
            <label class="block text-sm text-gray-500 mb-2">ğŸ« í•™êµë¥¼ ê²€ìƒ‰í•´ë´!</label>
            <div class="flex gap-2 relative">
                <input type="text" id="schoolSearchInput" class="cute-input w-full text-lg" placeholder="ì˜ˆ: ì œì£¼ì˜ì§€í•™êµ" onkeypress="if(event.keyCode==13) searchSchool()">
                <button onclick="searchSchool()" class="cute-btn text-lg whitespace-nowrap">ê²€ìƒ‰ğŸ”</button>
            </div>
            
            <!-- í•™êµ ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ -->
            <div id="schoolList" class="mt-2 max-h-48 overflow-y-auto bg-white rounded-xl shadow-inner hidden">
                <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ì„ íƒëœ í•™êµ í‘œì‹œ -->
        <div id="selectedSchoolInfo" class="hidden mb-6 p-4 bg-blue-50 rounded-xl text-center text-blue-400 border border-blue-100">
            <span id="selectedSchoolName" class="text-xl"></span> ì´(ê°€) ì„ íƒëì–´! âœ¨
        </div>

        <!-- ë‚ ì§œ ì„ íƒ ì„¹ì…˜ -->
        <div class="mb-6">
            <label class="block text-sm text-gray-500 mb-2">ğŸ“… ì–¸ì œ ê¸‰ì‹ì´ ê¶ê¸ˆí•´?</label>
            <input type="date" id="datePicker" class="cute-input w-full text-lg text-center" onchange="fetchMealData()">
        </div>

        <!-- ê¸‰ì‹ ê²°ê³¼ ì˜ì—­ -->
        <div id="mealResultArea" class="mt-4">
            <div class="text-center text-gray-400 py-8">
                í•™êµë¥¼ ê²€ìƒ‰í•˜ê³  ì„ íƒí•˜ë©´<br>ë§›ìˆëŠ” ì‹ë‹¨í‘œê°€ ë‚˜ì˜¬ ê±°ì•¼! ğŸ˜‹
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜: ì„ íƒëœ í•™êµ ì •ë³´ ì €ì¥
        let currentEduCode = '';
        let currentSchoolCode = '';

        // ì´ˆê¸°í™”: ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
        window.onload = () => {
            const today = new Date();
            // í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ë§ì¶”ê¸°
            const offset = today.getTimezoneOffset() * 60000;
            const dateOffset = new Date(today.getTime() - offset);
            const todayString = dateOffset.toISOString().split('T')[0];
            document.getElementById('datePicker').value = todayString;
        };

        // 1. í•™êµ ê²€ìƒ‰ API í˜¸ì¶œ (XML íŒŒì‹±)
        function searchSchool() {
            const keyword = document.getElementById('schoolSearchInput').value.trim();
            if (!keyword) {
                alert('í•™êµ ì´ë¦„ì„ ì…ë ¥í•´ì¤˜! ğŸ¥º');
                return;
            }

            const schoolListEl = document.getElementById('schoolList');
            schoolListEl.innerHTML = '<div class="p-4 text-center text-gray-400">ê²€ìƒ‰ ì¤‘... ğŸš€</div>';
            schoolListEl.classList.remove('hidden');

            // í•™êµ ê¸°ë³¸ì •ë³´ API ì—”ë“œí¬ì¸íŠ¸
            const url = `https://open.neis.go.kr/hub/schoolInfo?SCHUL_NM=${encodeURIComponent(keyword)}`;

            fetch(url)
                .then(response => response.text())
                .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
                .then(data => {
                    const rows = data.getElementsByTagName('row');
                    schoolListEl.innerHTML = ''; // ì´ˆê¸°í™”

                    if (rows.length === 0) {
                        schoolListEl.innerHTML = '<div class="p-4 text-center text-gray-400">í•™êµë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´... ë‹¤ì‹œ í™•ì¸í•´ì¤„ë˜? ğŸ˜¥</div>';
                        return;
                    }

                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        const eduCode = row.getElementsByTagName('ATPT_OFCDC_SC_CODE')[0].textContent;
                        const schoolCode = row.getElementsByTagName('SD_SCHUL_CODE')[0].textContent;
                        const schoolName = row.getElementsByTagName('SCHUL_NM')[0].textContent;
                        const address = row.getElementsByTagName('ORG_RDNMA')[0]?.textContent || '';

                        const div = document.createElement('div');
                        div.className = 'school-list-item';
                        div.innerHTML = `
                            <div class="text-lg text-gray-700">${schoolName}</div>
                            <div class="text-xs text-gray-400">${address}</div>
                        `;
                        div.onclick = () => selectSchool(eduCode, schoolCode, schoolName);
                        schoolListEl.appendChild(div);
                    }
                })
                .catch(error => {
                    console.error('Error fetching school data:', error);
                    schoolListEl.innerHTML = '<div class="p-4 text-center text-red-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆì–´ ğŸ˜­</div>';
                });
        }

        // 2. í•™êµ ì„ íƒ ì‹œ ì²˜ë¦¬
        function selectSchool(eduCode, schoolCode, schoolName) {
            currentEduCode = eduCode;
            currentSchoolCode = schoolCode;
            
            document.getElementById('selectedSchoolName').textContent = schoolName;
            document.getElementById('selectedSchoolInfo').classList.remove('hidden');
            
            // ê²€ìƒ‰ ë¦¬ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸° ë° ì…ë ¥ì°½ ë¹„ìš°ê¸°
            document.getElementById('schoolList').classList.add('hidden');
            document.getElementById('schoolSearchInput').value = '';

            // ê¸‰ì‹ ë°ì´í„° ë°”ë¡œ ê°€ì ¸ì˜¤ê¸°
            fetchMealData();
        }

        // 3. ê¸‰ì‹ ì‹ë‹¨ API í˜¸ì¶œ ë° ê²°ê³¼ ì¶œë ¥ (XML íŒŒì‹±)
        function fetchMealData() {
            if (!currentEduCode || !currentSchoolCode) {
                return; // í•™êµê°€ ì•„ì§ ì„ íƒë˜ì§€ ì•ŠìŒ
            }

            const dateStr = document.getElementById('datePicker').value;
            const formattedDate = dateStr.replace(/-/g, ''); // 2022-03-01 -> 20220301 í˜•ì‹ìœ¼ë¡œ ë³€í™˜

            const resultArea = document.getElementById('mealResultArea');
            resultArea.innerHTML = '<div class="text-center text-gray-400 py-8">ë§›ìˆëŠ” ë©”ë‰´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘... ğŸ³</div>';

            const url = `https://open.neis.go.kr/hub/mealServiceDietInfo?ATPT_OFCDC_SC_CODE=${currentEduCode}&SD_SCHUL_CODE=${currentSchoolCode}&MLSV_YMD=${formattedDate}`;

            fetch(url)
                .then(response => response.text())
                .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
                .then(data => {
                    const resultArea = document.getElementById('mealResultArea');
                    resultArea.innerHTML = '';

                    const rows = data.getElementsByTagName('row');

                    if (rows.length === 0) {
                        resultArea.innerHTML = `
                            <div class="meal-card text-center text-gray-500 py-8">
                                <div class="text-4xl mb-2">ğŸ½ï¸</div>
                                ì„ íƒí•œ ë‚ ì§œì—ëŠ” ê¸‰ì‹ ì •ë³´ê°€ ì—†ë„¤...<br>ì‰¬ëŠ” ë‚ ì´ê±°ë‚˜ ì•„ì§ ì•ˆ ì˜¬ë¼ì™”ë‚˜ ë´!
                            </div>
                        `;
                        return;
                    }

                    // ì¡°ì‹, ì¤‘ì‹, ì„ì‹ ë“± ì—¬ëŸ¬ ê°œì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë°˜ë³µë¬¸ ì²˜ë¦¬
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        const mealName = row.getElementsByTagName('MMEAL_SC_NM')[0].textContent; // ì¡°ì‹, ì¤‘ì‹ ë“±
                        let dishRaw = row.getElementsByTagName('DDISH_NM')[0].textContent; // ë©”ë‰´
                        const calInfo = row.getElementsByTagName('CAL_INFO')[0].textContent; // ì¹¼ë¡œë¦¬

                        // <br/> íƒœê·¸ ì²˜ë¦¬ ë° ì•Œë ˆë¥´ê¸° ì •ë³´ ìŠ¤íƒ€ì¼ë§
                        // CDATA ì•ˆì— ë“¤ì–´ìˆëŠ” <br/>ì„ ì‹¤ì œ html <br>ë¡œ ì¹˜í™˜
                        dishRaw = dishRaw.replace(/<br\s*\/?>/gi, '<br>');
                        
                        // ìˆ«ì.ìˆ«ì. í˜•íƒœì˜ ì•Œë ˆë¥´ê¸° ì •ë³´ë¥¼ ì‘ê³  íë¦¬ê²Œ ë³´ì´ë„ë¡ ë³€í™˜
                        const formattedDish = dishRaw.replace(/([0-9]+\.)+/g, match => `<span class="allergy-info ml-1">${match}</span>`);

                        const card = document.createElement('div');
                        card.className = 'meal-card';
                        card.innerHTML = `
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h2 class="text-2xl text-pink-500">${mealName} ğŸ’–</h2>
                                <span class="bg-blue-100 text-blue-500 text-sm px-3 py-1 rounded-full">${calInfo}</span>
                            </div>
                            <div class="dish-text text-gray-700">
                                ${formattedDish}
                            </div>
                        `;
                        resultArea.appendChild(card);
                    }
                })
                .catch(error => {
                    console.error('Error fetching meal data:', error);
                    document.getElementById('mealResultArea').innerHTML = `
                        <div class="meal-card text-center text-red-400 py-8">
                            ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì¤˜! ğŸ˜­
                        </div>
                    `;
                });
        }
    </script>
</body>
</html>